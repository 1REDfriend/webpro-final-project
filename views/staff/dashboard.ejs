<%- include('../layouts/header') %>

    <style>
        .badge-Pending {
            background: #f39c12;
            color: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.82em;
        }

        .badge-Approved {
            background: #27ae60;
            color: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.82em;
        }

        .badge-Rejected {
            background: #e74c3c;
            color: #fff;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.82em;
        }

        .announce-card {
            background: rgba(99, 102, 241, 0.06);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .announce-badge {
            font-size: 0.75em;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .badge-student {
            background: #3498db22;
            color: #3498db;
        }

        .badge-teacher {
            background: #27ae6022;
            color: #27ae60;
        }

        .badge-both {
            background: #9b59b622;
            color: #9b59b6;
        }

        /* Scrollable dual-column panels */
        .staff-dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        @media (max-width: 900px) {
            .staff-dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .panel-card-header {
            padding: 1.1rem 1.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .panel-card-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .panel-card-body {
            overflow-y: auto;
            flex: 1;
            padding: 1rem 1.5rem;
        }

        /* Requests mini table */
        .req-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
        }

        .req-table th {
            text-align: left;
            padding: 0.4rem 0.5rem;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .req-table td {
            padding: 0.55rem 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: top;
        }

        /* Announce form */
        .announce-form-section {
            padding: 1rem 1.5rem 0.5rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
    </style>

    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2 style="margin:0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á</h2>
        <div style="display:flex;gap:1rem;align-items:center;">
            <% let profileImg='/image/default-profile.png' ; if (user && user.profile_pic && user.profile_pic
                !=='default.png' ) { profileImg=user.profile_pic.startsWith('http') || user.profile_pic.startsWith('/')
                ? user.profile_pic : '/image/' + user.profile_pic; } %>
                <div style="text-align:right;">
                    <p style="margin:0;font-weight:bold;">
                        <%= user ? user.full_name : '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà' %>
                    </p>
                    <small class="text-muted">‡∏ù‡πà‡∏≤‡∏¢‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô / ‡∏ò‡∏∏‡∏£‡∏Å‡∏≤‡∏£</small>
                </div>
                <img src="<%= profileImg %>" alt="Profile"
                    style="border-radius:50%;width:50px;height:50px;object-fit:cover;border:2px solid #6c5ce7;">
        </div>
    </div>

    <!-- Dual Panel Grid -->
    <div class="staff-dashboard-grid">

        <!-- LEFT: Requests Panel -->
        <div class="panel-card">
            <div class="panel-card-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    <span style="font-size:0.82em;color:var(--text-muted);font-weight:400;">(<%= requests.length %>
                            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                </h3>
            </div>
            <div class="panel-card-body">
                <% if (requests && requests.length> 0) { %>
                    <table class="req-table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á</th>
                                <th>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% requests.forEach(req=> { %>
                                <tr>
                                    <td style="white-space:nowrap;">
                                        <%= new Date(req.date).toLocaleDateString('th-TH') %>
                                    </td>
                                    <td>
                                        <%= req.sender_name %><br>
                                            <span style="color:var(--accent);font-size:0.8em;">
                                                <%= req.sender_role %>
                                            </span>
                                    </td>
                                    <td>
                                        <strong>
                                            <%= req.topic %>
                                        </strong><br>
                                        <span style="font-size:0.82em;color:var(--text-muted);">
                                            <%= req.description ? req.description.substring(0,60) : '' %>
                                                <%= req.description && req.description.length> 60 ? '...' : '' %>
                                        </span>
                                        <% if (req.reply) { %><br><small class="text-muted">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö: <%= req.reply %>
                                                    </small>
                                            <% } %>
                                                <% if (req.attachment_url) { %>
                                                    <br><a href="/<%= req.attachment_url %>" target="_blank"
                                                        style="color:var(--accent);font-size:.82em;">üìé ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a>
                                                    <% } %>
                                    </td>
                                    <td>
                                        <span class="badge badge-<%= req.status %>">
                                            <%= req.status==='Pending' ? '‡∏£‡∏≠' : req.status==='Approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'
                                                : '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' %>
                                        </span>
                                    </td>
                                    <td>
                                        <% if (req.status==='Pending' ) { %>
                                            <form action="/staff/request-update" method="POST"
                                                style="display:flex;flex-direction:column;gap:.35rem;">
                                                <input type="hidden" name="id" value="<%= req.id %>">
                                                <input type="text" name="reply" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•/‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö"
                                                    class="form-control"
                                                    style="width:130px;padding:.3rem .5rem;font-size:.8rem;">
                                                <div style="display:flex;gap:.3rem;">
                                                    <button type="submit" name="status" value="Approved"
                                                        class="btn btn-success"
                                                        style="padding:.25rem .5rem;font-size:.78rem;">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                                    <button type="submit" name="status" value="Rejected"
                                                        class="btn btn-danger"
                                                        style="padding:.25rem .5rem;font-size:.78rem;">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                                </div>
                                            </form>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                                <% } %>
                                    </td>
                                </tr>
                                <% }); %>
                        </tbody>
                    </table>
                    <% } else { %>
                        <p class="text-muted" style="text-align:center;padding:2rem 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏£‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                        <% } %>
            </div>
        </div>

        <!-- RIGHT: Announcements Panel -->
        <div class="panel-card">
            <div class="panel-card-header">
                <h3 style="display:flex;align-items:center;gap:.5rem;">
                    <i data-lucide="megaphone" style="width:18px;height:18px;"></i>
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    <span style="font-size:0.82em;color:var(--text-muted);font-weight:400;">(<%= announcements ?
                            announcements.length : 0 %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                </h3>
            </div>

            <!-- Create Form (fixed, not scrollable) -->
            <div class="announce-form-section">
                <form action="/staff/announcements" method="POST">
                    <div style="display:grid;gap:.6rem;">
                        <input type="text" name="title" class="form-control" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® *" required>
                        <textarea name="description" class="form-control" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *" required
                            style="resize:vertical;"></textarea>
                        <div style="display:flex;gap:.6rem;flex-wrap:wrap;">
                            <input type="text" name="image_url" class="form-control" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                                style="flex:1;min-width:160px;">
                            <select name="target_audience" class="form-control" style="flex:1;min-width:140px;">
                                <option value="both">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
                                <option value="student">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                <option value="teacher">‡∏Ñ‡∏£‡∏π</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                    </div>
                </form>
            </div>

            <!-- Announcement List (scrollable) -->
            <div class="panel-card-body">
                <% if (announcements && announcements.length> 0) { %>
                    <% announcements.forEach(a=> { %>
                        <div class="announce-card">
                            <div style="flex:1;">
                                <div
                                    style="display:flex;gap:.5rem;align-items:center;margin-bottom:.3rem;flex-wrap:wrap;">
                                    <strong>
                                        <%= a.title %>
                                    </strong>
                                    <span class="announce-badge badge-<%= a.target_audience %>">
                                        <%= a.target_audience==='student' ? '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' : a.target_audience==='teacher'
                                            ? '‡∏Ñ‡∏£‡∏π' : '‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô' %>
                                    </span>
                                    <% if (a.image_url) { %>
                                        <span style="font-size:0.75em;color:var(--text-muted);">üñºÔ∏è ‡∏°‡∏µ‡∏£‡∏π‡∏õ</span>
                                        <% } %>
                                </div>
                                <p style="margin:0;font-size:.86em;color:var(--text-muted);">
                                    <%= a.description || a.description_markdown %>
                                </p>
                                <small style="color:var(--text-muted);">
                                    <%= a.creator_name %> ¬∑ <%= new Date(a.created_at).toLocaleDateString('th-TH') %>
                                </small>
                            </div>
                            <form action="/staff/announcements/delete" method="POST" style="margin:0;"
                                onsubmit="return confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ?')">
                                <input type="hidden" name="id" value="<%= a.id %>">
                                <button type="submit"
                                    style="background:none;border:none;color:#e74c3c;cursor:pointer;padding:4px;">
                                    <i data-lucide="trash-2" style="width:18px;height:18px;"></i>
                                </button>
                            </form>
                        </div>
                        <% }); %>
                            <% } else { %>
                                <p style="color:var(--text-muted);text-align:center;padding:2rem 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</p>
                                <% } %>
            </div>
        </div>

    </div>

    <%- include('../layouts/footer') %>