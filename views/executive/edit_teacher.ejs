<%- include('../layouts/header') %>

    <style>
        .pic-preview {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--accent);
            padding-bottom: .35rem;
            margin: 0 0 .9rem;
            color: var(--text-main);
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            gap: .3rem;
            background: rgba(99, 102, 241, 0.12);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: .82em;
            font-weight: 600;
        }

        .tag-pill form {
            margin: 0;
        }

        .tag-pill button {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            padding: 0;
            font-size: .9em;
            line-height: 1;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2 style="margin:0;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π</h2>
        <a href="/executive/teachers" class="btn btn-secondary">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>

    <% if (error) { %>
        <div class="alert-error">
            <%= error %>
        </div>
        <% } %>
            <% if (success) { %>
                <div class="alert-success">
                    <%= success %>
                </div>
                <% } %>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1.25rem; align-items:start;">

                        <!-- ‚îÄ‚îÄ LEFT: Basic Info Form ‚îÄ‚îÄ -->
                        <div style="display:flex;flex-direction:column;gap:1.25rem;">
                            <div class="card">
                                <div class="section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
                                <form action="/executive/teachers/<%= teacher.id %>/edit" method="POST"
                                    enctype="multipart/form-data">
                                    <input type="hidden" name="existing_pic"
                                        value="<%= teacher.profile_pic || 'default-profile-men.png' %>">

                                    <div style="display:flex;gap:1.2rem;align-items:center;margin-bottom:1rem;">
                                        <% let picSrc='/image/default-profile-men.png' ; if (teacher.profile_pic &&
                                            teacher.profile_pic !=='default.png' ) {
                                            picSrc=teacher.profile_pic.startsWith('http') ||
                                            teacher.profile_pic.startsWith('/') ? teacher.profile_pic : '/image/' +
                                            teacher.profile_pic; } %>
                                            <img src="<%= picSrc %>" class="pic-preview" id="picPreview" alt="Profile">
                                            <div style="flex:1;">
                                                <input type="file" name="profile_pic_file" accept="image/*"
                                                    class="form-control" style="margin-bottom:.4rem;"
                                                    onchange="document.getElementById('picPreview').src=URL.createObjectURL(this.files[0])">
                                                <label
                                                    style="font-size:.8em;color:var(--text-muted);display:flex;align-items:center;gap:.3rem;">
                                                    <input type="checkbox" name="clear_pic" value="1"> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô
                                                    default ‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
                                                </label>
                                            </div>
                                    </div>

                                    <div class="form-group mb-3">
                                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                        <input type="text" name="full_name" class="form-control"
                                            value="<%= teacher.full_name %>" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>Username</label>
                                        <input type="text" name="username" class="form-control"
                                            value="<%= teacher.username %>" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>‡πÄ‡∏û‡∏®</label>
                                        <select name="gender" class="form-control">
                                            <option value="male" <%=teacher.gender==='male' ?'selected':''%>>‡∏ä‡∏≤‡∏¢
                                            </option>
                                            <option value="female" <%=teacher.gender==='female' ?'selected':''%>>‡∏´‡∏ç‡∏¥‡∏á
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà <small
                                                class="text-muted">(‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</small></label>
                                        <input type="password" name="password" class="form-control"
                                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">üíæ
                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                                </form>
                            </div>
                        </div>

                        <!-- ‚îÄ‚îÄ RIGHT: Subject + Homeroom Management ‚îÄ‚îÄ -->
                        <div style="display:flex;flex-direction:column;gap:1.25rem;">

                            <!-- Assigned Subjects -->
                            <div class="card">
                                <div class="section-title">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (<%= assignedSubjects.length %>)</div>
                                <div
                                    style="display:flex;flex-wrap:wrap;gap:.4rem;min-height:32px;margin-bottom:.75rem;">
                                    <% if (assignedSubjects.length> 0) { %>
                                        <% assignedSubjects.forEach(s=> { %>
                                            <span class="tag-pill">
                                                <%= s.code %> - <%= s.name %>
                                                        <form
                                                            action="/executive/teachers/<%= teacher.id %>/subjects/unassign"
                                                            method="POST"
                                                            onsubmit="return confirm('‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ <%= s.code %> ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')">
                                                            <input type="hidden" name="subject_id" value="<%= s.id %>">
                                                            <button type="submit" title="‡∏ñ‡∏≠‡∏ô">‚úï</button>
                                                        </form>
                                            </span>
                                            <% }) %>
                                                <% } else { %>
                                                    <p style="color:var(--text-muted);font-size:.85em;margin:0;">
                                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
                                                    <% } %>
                                </div>

                                <!-- Add subject -->
                                <% if (unassignedSubjects.length> 0) { %>
                                    <form action="/executive/teachers/<%= teacher.id %>/subjects/assign" method="POST"
                                        style="display:flex;gap:.5rem;">
                                        <select name="subject_id" class="form-control" required style="flex:1;">
                                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ --</option>
                                            <% unassignedSubjects.forEach(s=> { %>
                                                <option value="<%= s.id %>">
                                                    <%= s.code %> - <%= s.name %>
                                                </option>
                                                <% }) %>
                                        </select>
                                        <button type="submit" class="btn btn-primary"
                                            style="white-space:nowrap;padding:.45rem .9rem;">+ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button>
                                    </form>
                                    <% } else { %>
                                        <p style="color:var(--text-muted);font-size:.82em;margin:0;">
                                            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà</p>
                                        <% } %>
                            </div>

                            <!-- Homeroom Classes -->
                            <div class="card">
                                <div class="section-title">‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÅ‡∏• (Homeroom) (<%= homeroomClasses.length %>)</div>
                                <div
                                    style="display:flex;flex-wrap:wrap;gap:.4rem;min-height:32px;margin-bottom:.75rem;">
                                    <% if (homeroomClasses.length> 0) { %>
                                        <% homeroomClasses.forEach(c=> { %>
                                            <span class="tag-pill">
                                                <%= c.name %>
                                                    <form
                                                        action="/executive/teachers/<%= teacher.id %>/homeroom/unassign"
                                                        method="POST"
                                                        onsubmit="return confirm('‡∏ñ‡∏≠‡∏ô‡∏´‡πâ‡∏≠‡∏á <%= c.name %> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')">
                                                        <input type="hidden" name="classroom_id" value="<%= c.id %>">
                                                        <button type="submit" title="‡∏ñ‡∏≠‡∏ô">‚úï</button>
                                                    </form>
                                            </span>
                                            <% }) %>
                                                <% } else { %>
                                                    <p style="color:var(--text-muted);font-size:.85em;margin:0;">
                                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏î</p>
                                                    <% } %>
                                </div>

                                <!-- Assign homeroom -->
                                <% const assignedIds=homeroomClasses.map(c=> c.id);
                                    const availableRooms = allClassrooms.filter(c => !assignedIds.includes(c.id));
                                    %>
                                    <% if (availableRooms.length> 0) { %>
                                        <form action="/executive/teachers/<%= teacher.id %>/homeroom/assign"
                                            method="POST" style="display:flex;gap:.5rem;">
                                            <select name="classroom_id" class="form-control" required style="flex:1;">
                                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ --</option>
                                                <% availableRooms.forEach(c=> { %>
                                                    <option value="<%= c.id %>">
                                                        <%= c.name %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <button type="submit" class="btn btn-primary"
                                                style="white-space:nowrap;padding:.45rem .9rem;">+ ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button>
                                        </form>
                                        <% } else { %>
                                            <p style="color:var(--text-muted);font-size:.82em;margin:0;">
                                                ‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
                                            <% } %>
                            </div>
                        </div>
                    </div>

                    <%- include('../layouts/footer') %>