<%- include('../layouts/header') %>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="margin: 0;">แผงควบคุมผู้บริหาร</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <% let profileImg='/image/default-profile.png' ; if (user && user.profile_pic && user.profile_pic
                !=='default.png' ) { profileImg=user.profile_pic.startsWith('http') || user.profile_pic.startsWith('/')
                ? user.profile_pic : '/image/' + user.profile_pic; } %>
                <div style="text-align: right;">
                    <p style="margin: 0; font-weight: bold;">
                        <%= user ? user.full_name : 'ผู้บริหาร' %>
                    </p>
                    <small class="text-muted">ผู้อำนวยการ / ผู้บริหาร</small>
                </div>
                <img src="<%= profileImg %>" alt="Profile"
                    style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover; border: 2px solid var(--primary);">
        </div>
    </div>

    <div class="grid-4 mb-4">
        <div class="card" style="text-align: center; border-top: 4px solid var(--primary);">
            <h4 class="text-muted">จำนวนนักเรียน</h4>
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);">
                <%= stats.studentCount %>
            </div>
            <p class="text-muted">คน ทั้งหมด</p>
        </div>

        <div class="card" style="text-align: center; border-top: 4px solid var(--accent);">
            <h4 class="text-muted">จำนวนครู</h4>
            <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent);">
                <%= stats.teacherCount %>
            </div>
            <p class="text-muted">คน ทั้งหมด</p>
        </div>

        <div class="card" style="text-align: center; border-top: 4px solid #6c5ce7;">
            <h4 class="text-muted">พนักงาน/ฝ่ายธุรการ</h4>
            <div style="font-size: 2.5rem; font-weight: bold; color: #6c5ce7;">
                <%= stats.staffCount %>
            </div>
            <p class="text-muted">คน ทั้งหมด</p>
        </div>

        <div class="card" style="text-align: center; border-top: 4px solid #00b894;">
            <h4 class="text-muted">เกรดเฉลี่ยรวม (โรงเรียน)</h4>
            <div style="font-size: 2.5rem; font-weight: bold; color: #00b894;">
                <%= stats.avgGpa %>
            </div>
            <p class="text-muted">GPA</p>
        </div>
    </div>

    <div class="grid-2">
        <div class="card">
            <h3>สถิติคำร้อง</h3>
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                <div
                    style="display: flex; align-items:center; gap:0.7rem; justify-content: space-between; padding: 0.85rem 1rem; background: #ffc400; border-radius: 8px;">
                    <span style="display:flex;align-items:center;gap:.4rem;font-weight:bold;color:#fff;">
                        <i data-lucide="clock" style="width:16px;height:16px;"></i> รอดำเนินการ
                    </span>
                    <span style="font-weight: bold; font-size: 1.2rem; color:#fff;">
                        <%= stats.requestPendingCount %>
                    </span>
                </div>
                <div
                    style="display: flex; align-items:center; gap:0.7rem; justify-content: space-between; padding: 0.85rem 1rem; background: #0bad31; border-radius: 8px;">
                    <span style="display:flex;align-items:center;gap:.4rem;font-weight:bold;color:#fff;">
                        <i data-lucide="check-circle" style="width:16px;height:16px;"></i> อนุมัติแล้ว
                    </span>
                    <span style="font-weight: bold; font-size: 1.2rem; color:#fff;">
                        <%= stats.requestApprovedCount %>
                    </span>
                </div>
                <div
                    style="display: flex; align-items:center; gap:0.7rem; justify-content: space-between; padding: 0.85rem 1rem; background: #dd2333; border-radius: 8px;">
                    <span style="display:flex;align-items:center;gap:.4rem;font-weight:bold;color:#fff;">
                        <i data-lucide="x-circle" style="width:16px;height:16px;"></i> ปฏิเสธ
                    </span>
                    <span style="font-weight: bold; font-size: 1.2rem; color:#fff;">
                        <%= stats.requestRejectedCount %>
                    </span>
                </div>
                <div
                    style="display: flex; align-items:center; gap:0.7rem; justify-content: space-between; padding: 0.85rem 1rem; background: #6c5ce7; border-radius: 8px;">
                    <span style="display:flex;align-items:center;gap:.4rem;font-weight:bold;color:#fff;">
                        <i data-lucide="file-text" style="width:16px;height:16px;"></i> รวมทั้งหมด
                    </span>
                    <span style="font-weight: bold; font-size: 1.2rem; color:#fff;">
                        <%= stats.requestTotalCount %>
                    </span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>เกรดเฉลี่ยแยกตามห้องเรียน</h3>
            <% if (stats.gpaByClassroom && stats.gpaByClassroom.length> 0) { %>
                <table style="margin-top: 1rem;">
                    <thead>
                        <tr>
                            <th>ห้องเรียน</th>
                            <th>เกรดเฉลี่ย</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% stats.gpaByClassroom.forEach(item=> { %>
                            <tr>
                                <td>
                                    <%= item.classroom %>
                                </td>
                                <td
                                    style="font-weight: bold; color: <%= item.gpa >= 3.0 ? '#00b894' : (item.gpa >= 2.0 ? '#e1b12c' : '#ff6b6b') %>;">
                                    <%= item.gpa %>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
                <% } else { %>
                    <p class="text-muted mt-4">ยังไม่มีข้อมูลผลการเรียนที่ถูกประมวลผลสำหรับรายห้อง</p>
                    <% } %>
        </div>
    </div>

    <!-- Request History Table -->
    <div class="card mt-4">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;">
            <h3 style="margin:0;">ประวัติคำร้องทั้งหมด</h3>
            <span class="text-muted" style="font-size:0.85em;">
                <%= allRequests.length %> รายการ
            </span>
        </div>

        <!-- Search box -->
        <div
            style="display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,0.05);border:1px solid var(--border);border-radius:8px;padding:.4rem .75rem;margin-bottom:0.75rem;">
            <i data-lucide="search" style="width:16px;height:16px;color:var(--text-muted);flex-shrink:0;"></i>
            <input id="execReqSearch" type="text" placeholder="ค้นหาชื่อ, หัวข้อ, สถานะ..."
                style="border:none;background:transparent;outline:none;font-size:0.9rem;color:var(--text-main);width:100%;"
                oninput="filterReqRows()">
        </div>

        <% if (allRequests && allRequests.length> 0) { %>
            <div style="overflow-x:auto;max-height:420px;overflow-y:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.88rem;">
                    <thead style="position:sticky;top:0;background:var(--bg-card);">
                        <tr>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);white-space:nowrap;">
                                วันที่</th>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">
                                ผู้ส่ง</th>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">
                                หัวข้อ</th>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">
                                รายละเอียด</th>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">
                                สถานะ</th>
                            <th
                                style="text-align:left;padding:.4rem .6rem;color:var(--text-muted);font-weight:600;border-bottom:1px solid var(--border);">
                                ตอบกลับ</th>
                        </tr>
                    </thead>
                    <tbody id="execReqTbody">
                        <% allRequests.forEach(req=> { %>
                            <tr style="border-bottom:1px solid rgba(255,255,255,0.04);">
                                <td style="padding:.5rem .6rem;white-space:nowrap;">
                                    <%= new Date(req.date).toLocaleDateString('th-TH') %>
                                </td>
                                <td style="padding:.5rem .6rem;">
                                    <%= req.sender_name %><br>
                                        <span style="font-size:0.8em;color:var(--accent);">
                                            <%= req.sender_role %>
                                        </span>
                                </td>
                                <td style="padding:.5rem .6rem;">
                                    <%= req.topic %>
                                </td>
                                <td
                                    style="padding:.5rem .6rem;max-width:180px;font-size:0.83rem;color:var(--text-muted);">
                                    <%= req.description ? req.description.substring(0, 55) : '-' %>
                                        <%= req.description && req.description.length> 55 ? '...' : '' %>
                                </td>
                                <td style="padding:.5rem .6rem;">
                                    <span style="padding:2px 9px;border-radius:12px;font-size:0.82em;
                                        background:<%= req.status==='Pending' ? '#f39c12' : req.status==='Approved' ? '#27ae60' : '#e74c3c' %>;
                                        color:#fff;">
                                        <%= req.status==='Pending' ? 'รอ' : req.status==='Approved' ? 'อนุมัติ'
                                            : 'ปฏิเสธ' %>
                                    </span>
                                </td>
                                <td style="padding:.5rem .6rem;font-size:0.85rem;">
                                    <%= req.reply || '-' %>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
            </div>
            <% } else { %>
                <p class="text-muted" style="text-align:center;padding:2rem 0;">ยังไม่มีคำร้องในระบบ</p>
                <% } %>
    </div>

    <script>
        function filterReqRows() {
            const q = document.getElementById('execReqSearch').value.toLowerCase();
            document.querySelectorAll('#execReqTbody tr').forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        }
    </script>

    <%- include('../layouts/footer') %>