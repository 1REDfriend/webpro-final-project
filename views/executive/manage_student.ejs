<%- include('../layouts/header') %>

    <style>
        .pic-preview {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--accent);
            padding-bottom: .35rem;
            margin: 0 0 .9rem;
            color: var(--text-main);
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 16px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
    </style>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2 style="margin:0;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <%= student.full_name %> (<%= student.student_code %>)</h2>
        <a href="/executive/students" class="btn btn-secondary">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
    </div>

    <% if (error) { %>
        <div class="alert-error">
            <%= error %>
        </div>
        <% } %>
            <% if (success) { %>
                <div class="alert-success">
                    <%= success %>
                </div>
                <% } %>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;align-items:start;">

                        <!-- ‚îÄ‚îÄ LEFT: Profile Edit Form ‚îÄ‚îÄ -->
                        <div class="card">
                            <div class="section-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
                            <form action="/executive/students/<%= student.student_id %>/edit" method="POST"
                                enctype="multipart/form-data">
                                <input type="hidden" name="existing_pic"
                                    value="<%= student.profile_pic || 'default-profile-men.png' %>">

                                <div style="display:flex;gap:1.2rem;align-items:center;margin-bottom:1rem;">
                                    <% let picSrc='/image/default-profile-men.png' ; if (student.profile_pic &&
                                        student.profile_pic !=='default.png' ) {
                                        picSrc=student.profile_pic.startsWith('http') ||
                                        student.profile_pic.startsWith('/') ? student.profile_pic : '/image/' +
                                        student.profile_pic; } %>
                                        <img src="<%= picSrc %>" class="pic-preview" id="picPreview" alt="Profile">
                                        <div style="flex:1;">
                                            <input type="file" name="profile_pic_file" accept="image/*"
                                                class="form-control" style="margin-bottom:.4rem;"
                                                onchange="document.getElementById('picPreview').src=URL.createObjectURL(this.files[0])">
                                            <label
                                                style="font-size:.8em;color:var(--text-muted);display:flex;align-items:center;gap:.3rem;">
                                                <input type="checkbox" name="clear_pic" value="1"> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô default
                                                ‡∏ï‡∏≤‡∏°‡πÄ‡∏û‡∏®
                                            </label>
                                        </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                                    <input type="text" name="full_name" class="form-control"
                                        value="<%= student.full_name %>" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (= Username)</label>
                                    <input type="text" name="student_code" class="form-control"
                                        value="<%= student.student_code %>" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label>‡πÄ‡∏û‡∏®</label>
                                    <select name="gender" class="form-control">
                                        <option value="male" <%=student.gender==='male' ?'selected':''%>>‡∏ä‡∏≤‡∏¢</option>
                                        <option value="female" <%=student.gender==='female' ?'selected':''%>>‡∏´‡∏ç‡∏¥‡∏á
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label>‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                    <select name="classroom_id" class="form-control" required>
                                        <% classrooms.forEach(c=> { %>
                                            <option value="<%= c.id %>" <%=student.classroom_id===c.id?'selected':''%>>
                                                <%= c.name %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>
                                <div class="form-group mb-4">
                                    <label>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà <small
                                            class="text-muted">(‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</small></label>
                                    <input type="password" name="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                </div>
                                <button type="submit" class="btn btn-primary" style="width:100%;">üíæ
                                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                            </form>
                        </div>

                        <!-- ‚îÄ‚îÄ RIGHT: Subject Management ‚îÄ‚îÄ -->
                        <div class="card">
                            <div class="section-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (<%= enrolledSubjects.length %>)</div>

                            <!-- Enrolled list with remove button -->
                            <% if (enrolledSubjects.length> 0) { %>
                                <div style="overflow-x:auto;margin-bottom:1rem;">
                                    <table style="width:100%;border-collapse:collapse;font-size:.9em;">
                                        <thead>
                                            <tr>
                                                <th
                                                    style="text-align:left;padding:.4rem .5rem;border-bottom:1px solid var(--border);">
                                                    ‡∏£‡∏´‡∏±‡∏™</th>
                                                <th
                                                    style="text-align:left;padding:.4rem .5rem;border-bottom:1px solid var(--border);">
                                                    ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th>
                                                <th
                                                    style="text-align:center;padding:.4rem .5rem;border-bottom:1px solid var(--border);">
                                                    ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï</th>
                                                <th
                                                    style="text-align:center;padding:.4rem .5rem;border-bottom:1px solid var(--border);">
                                                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% enrolledSubjects.forEach(sub=> { %>
                                                <tr style="border-bottom:1px solid var(--border);">
                                                    <td style="padding:.4rem .5rem;">
                                                        <%= sub.code %>
                                                    </td>
                                                    <td style="padding:.4rem .5rem;">
                                                        <%= sub.name %>
                                                    </td>
                                                    <td style="padding:.4rem .5rem;text-align:center;">
                                                        <%= sub.credit %>
                                                    </td>
                                                    <td style="padding:.4rem .5rem;text-align:center;">
                                                        <form
                                                            action="/executive/students/<%= student.student_id %>/manage/subjects/remove"
                                                            method="POST" style="display:inline;"
                                                            onsubmit="confirmAction(event,'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ <%= sub.code %>? ‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏î‡πâ‡∏ß‡∏¢')">
                                                            <input type="hidden" name="subject_id"
                                                                value="<%= sub.id %>">
                                                            <button type="submit"
                                                                style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:1.1em;"
                                                                title="‡∏ñ‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤">
                                                                <i data-lucide="trash-2"
                                                                    style="width:16px;height:16px;"></i>
                                                            </button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                <% }) %>
                                        </tbody>
                                    </table>
                                </div>
                                <% } else { %>
                                    <p style="color:var(--text-muted);font-size:.88em;margin-bottom:1rem;">
                                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏î</p>
                                    <% } %>

                                        <!-- Add subject -->
                                        <div class="section-title" style="margin-top:.5rem;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div>
                                        <% if (availableSubjects && availableSubjects.length> 0) { %>
                                            <form
                                                action="/executive/students/<%= student.student_id %>/manage/subjects/add"
                                                method="POST" style="display:flex;gap:.5rem;">
                                                <select name="subject_id" class="form-control" required style="flex:1;">
                                                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
                                                    <% availableSubjects.forEach(sub=> { %>
                                                        <option value="<%= sub.id %>">
                                                            <%= sub.code %> - <%= sub.name %> (<%= sub.credit %>
                                                                        ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏¥‡∏ï)
                                                        </option>
                                                        <% }) %>
                                                </select>
                                                <button type="submit" class="btn btn-primary"
                                                    style="white-space:nowrap;padding:.45rem .9rem;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                            </form>
                                            <% } else { %>
                                                <p style="color:var(--text-muted);font-size:.85em;margin:0;">
                                                    ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß</p>
                                                <% } %>
                        </div>
                    </div>

                    <%- include('../layouts/footer') %>